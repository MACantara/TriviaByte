{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Question Analytics</h1>
        <div class="d-flex gap-2">
            <select id="sortBy" class="form-select">
                <option value="accuracy">Sort by Accuracy</option>
                <option value="total_score">Sort by Total Score</option>
                <option value="avg_time_taken">Sort by Average Time</option>
                <option value="correct_answers">Sort by Correct Answers</option>
            </select>
            <button id="refreshData" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>
    
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <div id="loadingState" class="text-center py-5 d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="mt-3 text-muted">Loading analytics data...</div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover" id="analyticsTable">
                    <thead class="table-light">
                        <tr>
                            <th>Question</th>
                            <th class="text-center">Correct</th>
                            <th class="text-center">Wrong</th>
                            <th class="text-center">Avg Time</th>
                            <th class="text-center">Total Score</th>
                            <th class="text-center">Accuracy</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div id="noDataMessage" class="text-center py-5 text-muted d-none">
                <i class="fas fa-chart-bar fa-3x mb-3"></i>
                <p class="mb-0">No analytics data available yet.</p>
            </div>
        </div>
    </div>
</div>

<script>
let analyticsData = [];

async function loadAnalyticsData() {
    try {
        $('#loadingState').removeClass('d-none');
        $('#analyticsTable, #noDataMessage').addClass('d-none');
        
        const response = await fetch('/analytics/api/questions');
        analyticsData = await response.json();
        
        if (analyticsData.length === 0) {
            $('#noDataMessage').removeClass('d-none');
            return;
        }

        displayData(analyticsData);
        $('#analyticsTable').removeClass('d-none');
    } catch (error) {
        console.error('Error loading analytics:', error);
        alert('Error loading analytics data. Please try again.');
    } finally {
        $('#loadingState').addClass('d-none');
    }
}

function displayData(data) {
    const tbody = document.querySelector('#analyticsTable tbody');
    tbody.innerHTML = '';
    
    data.forEach(item => {
        tbody.innerHTML += `
            <tr>
                <td>${item.question}</td>
                <td class="text-center text-success fw-bold">${item.correct_answers}</td>
                <td class="text-center text-danger fw-bold">${item.wrong_answers}</td>
                <td class="text-center">${item.avg_time_taken.toFixed(1)}s</td>
                <td class="text-center">${item.total_score.toLocaleString()}</td>
                <td class="text-center">
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar ${getAccuracyClass(item.accuracy)}" 
                             role="progressbar" 
                             style="width: ${item.accuracy}%">
                            ${item.accuracy}%
                        </div>
                    </div>
                </td>
            </tr>
        `;
    });
}

function getAccuracyClass(accuracy) {
    if (accuracy >= 80) return 'bg-success';
    if (accuracy >= 60) return 'bg-info';
    if (accuracy >= 40) return 'bg-warning';
    return 'bg-danger';
}

function sortData(field) {
    analyticsData.sort((a, b) => b[field] - a[field]);
    displayData(analyticsData);
}

document.addEventListener('DOMContentLoaded', () => {
    loadAnalyticsData();
    
    $('#sortBy').on('change', (e) => sortData(e.target.value));
    $('#refreshData').on('click', loadAnalyticsData);
});
</script>
{% endblock %}
